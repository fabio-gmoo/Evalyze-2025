<!-- Eva-Front/src/app/components/interview-chat/interview-chat.html -->

<div class="interview-chat-container">
  @if (!sessionId) {
    <div class="no-session">
      <p>No hay sesión de entrevista disponible</p>
    </div>
  } @else {
    <!-- Session Info -->
    @if (session()) {
      <div class="chat-header-compact">
        <div class="header-left">
          <span class="status-dot" [class]="session()?.status"></span>
          <div class="header-text">
            <span class="title">Entrevista Técnica</span>
            <span class="subtitle">{{ session()?.company_name || 'Asistente IA' }}</span>
          </div>
        </div>

        @if (session()?.status === 'active') {
          <button (click)="showFinalizeDialog()" [disabled]="isFinalizing()" class="btn-finalize-mini">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            </svg>
            Finalizar
          </button>
        }
      </div>
    }

    <!-- Messages Area -->
    <div class="messages-area" #messagesContainer>
      @for (msg of messages(); track $index) {
        <div class="message" [class]="'message-' + msg.sender">
          <div class="message-content">{{ msg.content }}</div>
          <div class="message-time">{{ formatTime(msg.timestamp) }}</div>
          @if (msg.score) {
            <div class="message-score">Puntuación: {{ msg.score }}</div>
          }
        </div>
      }

      @if (isTyping()) {
        <div class="message message-ai">
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      }
    </div>

    <!-- Start Interview Button (Pending State) -->
    @if (session()?.status === 'pending') {
      <div class="start-area">
        <button (click)="startInterview()" [disabled]="loading()" class="btn-start">
          {{ loading() ? 'Iniciando...' : 'Iniciar Entrevista' }}
        </button>
      </div>
    }

    <!-- Input Area (Active State) -->
    @if (session()?.status === 'active') {
      <div class="input-area compact">
        <textarea
          [(ngModel)]="draft"
          (keydown.ctrl.enter)="sendMessage()"
          [disabled]="isTyping()"
          placeholder="Escribe tu respuesta..."
          rows="1"
        ></textarea>
        <button (click)="sendMessage()" [disabled]="!draft().trim() || isTyping()" class="btn-send-round">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
             <line x1="22" y1="2" x2="11" y2="13"></line>
             <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    }


    <!-- Completed State -->
    
  }
</div>

<!-- Finalize Confirmation Dialog -->
@if (showFinalizeConfirm()) {
  <div class="modal-overlay" (click)="cancelFinalize()">
    <div class="confirm-dialog" (click)="$event.stopPropagation()">
      <div class="dialog-icon">
        <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
          <polyline points="22 4 12 14.01 9 11.01" />
        </svg>
      </div>

      <h3>¿Finalizar Entrevista?</h3>

      <p>
        Una vez finalizada, tu entrevista será analizada por IA y recibirás un informe completo con:
      </p>

      <ul class="benefits-list">
        <li>
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor">
            <polyline points="20 6 9 17 4 12" />
          </svg>
          Análisis SWOT de tu desempeño
        </li>
        <li>
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor">
            <polyline points="20 6 9 17 4 12" />
          </svg>
          Puntuación cuantitativa (0-100%)
        </li>
        <li>
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor">
            <polyline points="20 6 9 17 4 12" />
          </svg>
          Recomendaciones personalizadas
        </li>
        <li>
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor">
            <polyline points="20 6 9 17 4 12" />
          </svg>
          Estrategias de desarrollo profesional
        </li>
      </ul>

      <div class="warning-box">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor">
          <path
            d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
          />
          <line x1="12" y1="9" x2="12" y2="13" />
          <line x1="12" y1="17" x2="12.01" y2="17" />
        </svg>
        <span>Esta acción no se puede deshacer.</span>
      </div>

      <div class="dialog-actions">
        <button class="btn-cancel" (click)="cancelFinalize()">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
          Cancelar
        </button>
        <button class="btn-confirm" (click)="finalizeInterview()" [disabled]="isFinalizing()">
          @if (isFinalizing()) {
            <span class="spinner-small"></span>
            Procesando...
          } @else {
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12" />
            </svg>
            Sí, Finalizar
          }
        </button>
      </div>
    </div>
  </div>
}
