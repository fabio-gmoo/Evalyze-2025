<!-- CONTENEDOR -->
<div class="vacantes-container">

  <!-- ======= HEADER ======= -->
  <header class="header">
    <div class="header-content">
      <div class="header-icon">
        <!-- icono simple -->
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <path d="M4 7h16M4 12h16M4 17h10" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div>
        <h1>Vacantes</h1>
        <p *ngIf="viewMode() === 'company'">Panel para gestionar posiciones con IA.</p>
        <p *ngIf="viewMode() === 'candidate'">Explora vacantes y aplica con entrevistas asistidas por IA.</p>
      </div>
    </div>
  </header>

  <!-- ======= STATS (solo empresa) ======= -->
  <section *ngIf="viewMode() === 'company'" class="stats-grid">
    <div class="stat-card" [ngClass]="'stat-' + s.color" *ngFor="let s of stats()">
      <h3>{{ s.title }}</h3>
      <div class="stat-value">{{ s.value }}</div>
      <div class="stat-change">{{ s.change }}</div>
    </div>
  </section>

  <!-- ======= TABS (solo empresa) ======= -->
  <nav *ngIf="viewMode() === 'company'" class="tabs">
    <button
      *ngFor="let t of tabs"
      class="tab-button"
      [class.active]="activeTab() === t.id"
      (click)="setActiveTab(t.id)">
      {{ t.label }}
    </button>
  </nav>

  <!-- ======= ACCIONES / TÍTULO DE SECCIÓN ======= -->
  <div class="section-header">
    <div>
      <h2 *ngIf="viewMode() === 'company'">Gestión de Vacantes</h2>
      <h2 *ngIf="viewMode() === 'candidate'">Todas las Vacantes</h2>
      <p *ngIf="viewMode() === 'company'">Crea y administra posiciones abiertas con configuración de IA.</p>
      <p *ngIf="viewMode() === 'candidate'">Aplica a las oportunidades que más te interesen.</p>
    </div>

    <div *ngIf="viewMode() === 'company'">
      <button class="btn-primary" (click)="openModal(null)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
        Nueva Vacante
      </button>
    </div>
  </div>

  <!-- ======= LISTA VACANTES ======= -->
  <section class="vacantes-list" *ngIf="vacantes()?.length; else emptyList">
    <article class="vacante-card" *ngFor="let v of vacantes()">
      <div class="vacante-header">
        <div class="vacante-title-section">
          <h3>{{ v.puesto }}</h3>
          <span *ngIf="v.activa" class="badge-active">Activa</span>
        </div>

        <div class="vacante-actions" *ngIf="viewMode() === 'company'">
          <button class="btn-icon" (click)="openModal(v)">Editar</button>
          <button class="btn-icon btn-delete" (click)="eliminarVacante(v.id!)">Eliminar</button>
        </div>

        <div class="vacante-actions" *ngIf="viewMode() === 'candidate'">
          <button class="btn-primary" (click)="openChat(v)">Aplicar Ahora</button>
        </div>
      </div>

      <div class="vacante-info-grid">
        <div class="info-item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 2l7 7-7 7-7-7 7-7z" stroke="#6366f1" stroke-width="2"/></svg>
          {{ v.ubicacion }}
        </div>
        <div class="info-item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 12h18" stroke="#6366f1" stroke-width="2" stroke-linecap="round"/></svg>
          {{ v.tipo_contrato || 'Tiempo Completo' }}
        </div>
        <div class="info-item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 6v12M6 12h12" stroke="#6366f1" stroke-width="2" stroke-linecap="round"/></svg>
          {{ v.salario }} <span *ngIf="viewMode() === 'company'">&nbsp;EUR</span>
        </div>
        <div class="info-item" *ngIf="viewMode() === 'company'">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="#6366f1" stroke-width="2"/></svg>
          {{ v.candidatos || 0 }} candidatos
        </div>
      </div>

      <div class="vacante-description">
        {{ v.descripcion }}
      </div>

      <footer class="vacante-footer">
        <div>Publicada: {{ v.publicada }}</div>
        <div>Cierra: {{ v.cierra }}</div>
        <div *ngIf="v.preguntasIA"> {{ v.preguntasIA }} preguntas IA</div>
        <div *ngIf="v.duracionIA">{{ v.duracionIA }}</div>
      </footer>
    </article>
  </section>

  <ng-template #emptyList>
    <div class="empty-state">
      <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a10 10 0 100 20 10 10 0 000-20zM7 11h10v2H7z"/></svg>
      <h3>No hay vacantes</h3>
      <p *ngIf="viewMode() === 'company'">Crea tu primera vacante para comenzar.</p>
      <button *ngIf="viewMode() === 'company'" class="btn-primary" (click)="openModal(null)">Nueva Vacante</button>
    </div>
  </ng-template>

  <!-- ======= MODAL CREAR/EDITAR ======= -->
  <div class="modal-overlay" *ngIf="showModal()">
    <div class="modal-content">
      <div class="modal-header">
        <h2>{{ editingVacante() ? 'Editar Vacante' : 'Nueva Vacante' }}</h2>
        <button class="btn-close" (click)="closeModal()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>

      <div class="modal-body">

        <!-- Datos básicos -->
        <section class="form-section">
          <h3>Datos del Puesto</h3>
          <div class="form-grid-2">
            <div class="form-group">
              <label>Título del puesto</label>
              <input class="form-input"
                     [ngModel]="formData().puesto"
                     (ngModelChange)="updateFormField('puesto', $event)"
                     placeholder="Ej: Desarrollador Frontend Senior" />
            </div>

            <div class="form-group">
              <label>Departamento / Área</label>
              <input class="form-input"
                     [ngModel]="formData().departamento"
                     (ngModelChange)="updateFormField('departamento', $event)"
                     placeholder="Ej: Tecnología" />
            </div>

            <div class="form-group">
              <label>Ubicación</label>
              <input class="form-input"
                     [ngModel]="formData().ubicacion"
                     (ngModelChange)="updateFormField('ubicacion', $event)"
                     placeholder="Ciudad, País" />
            </div>

            <div class="form-group">
              <label>Tipo de contrato</label>
              <select class="form-select"
                      [ngModel]="formData().tipo_contrato"
                      (ngModelChange)="updateFormField('tipo_contrato', $event)">
                <option>Tiempo Completo</option>
                <option>Medio Tiempo</option>
                <option>Contrato</option>
                <option>Prácticas</option>
              </select>
            </div>

            <div class="form-group">
              <label>Salario Mínimo</label>
              <input class="form-input" type="number"
                     [ngModel]="formData().salarioMin"
                     (ngModelChange)="updateFormField('salarioMin', $event)"
                     placeholder="45000" />
            </div>

            <div class="form-group">
              <label>Salario Máximo</label>
              <input class="form-input" type="number"
                     [ngModel]="formData().salarioMax"
                     (ngModelChange)="updateFormField('salarioMax', $event)"
                     placeholder="65000" />
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
              <div class="form-group-header">
                <label>Descripción</label>
                <button class="btn-generate-ia" (click)="generarConIA()" [disabled]="loading()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 2l3 6 6 1-4 4 1 6-6-3-6 3 1-6-4-4 6-1 3-6z" stroke="white" stroke-width="1.5"/></svg>
                  Generar con IA
                  <span *ngIf="loading()" class="loading-spinner" style="margin-left:.5rem;"></span>
                </button>
              </div>
              <textarea class="form-textarea" rows="5"
                        [ngModel]="formData().descripcion"
                        (ngModelChange)="updateFormField('descripcion', $event)"
                        placeholder="Resumen del puesto, objetivos, etc."></textarea>
            </div>
          </div>
        </section>

        <!-- Requisitos / Responsabilidades -->
        <section class="form-section">
          <h3>Requisitos</h3>
          <div class="form-group" *ngFor="let r of formData().requisitos; let i = index">
            <div class="array-input-group">
              <input class="form-input"
                     [ngModel]="r"
                     (ngModelChange)="updateArrayItem('requisitos', i, $event)"
                     placeholder="Ej: 5+ años con React" />
              <button class="btn-remove" (click)="removeArrayItem('requisitos', i)">Quitar</button>
            </div>
          </div>
          <button class="btn-add-item" (click)="addArrayItem('requisitos')">+ Agregar requisito</button>
        </section>

        <section class="form-section">
          <h3>Responsabilidades</h3>
          <div class="form-group" *ngFor="let r of formData().responsabilidades; let i = index">
            <div class="array-input-group">
              <input class="form-input"
                     [ngModel]="r"
                     (ngModelChange)="updateArrayItem('responsabilidades', i, $event)"
                     placeholder="Ej: Optimizar rendimiento" />
              <button class="btn-remove" (click)="removeArrayItem('responsabilidades', i)">Quitar</button>
            </div>
          </div>
          <button class="btn-add-item" (click)="addArrayItem('responsabilidades')">+ Agregar responsabilidad</button>
        </section>

        <!-- Config de entrevista IA -->
        <section class="form-section">
          <h3>Configuración de Entrevista IA</h3>
          <div class="form-grid-2">
            <div class="form-group">
              <label>Duración (min)</label>
              <input class="form-input" type="number"
                     [ngModel]="formData().duracion"
                     (ngModelChange)="updateFormField('duracion', $event)" />
            </div>
            <div class="form-group">
              <label>Puntuación mínima (%)</label>
              <input class="form-input" type="number"
                     [ngModel]="formData().puntuacionMinima"
                     (ngModelChange)="updateFormField('puntuacionMinima', $event)" />
            </div>
          </div>

          <div class="form-group">
            <div class="form-group-header">
              <label>Preguntas</label>
              <button class="btn-add-question" (click)="addPregunta()">+ Añadir pregunta</button>
            </div>

            <div class="pregunta-card"
                 *ngFor="let p of preguntas(); let i = index; trackBy: trackByPregunta">
              <div class="pregunta-header">
                <h4>Pregunta {{ i + 1 }}</h4>
                <button class="btn-icon-only btn-delete" (click)="removePregunta(i)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                </button>
              </div>

              <div class="form-group">
                <label>Enunciado</label>
                <input class="form-input"
                       [ngModel]="p.pregunta"
                       (ngModelChange)="updatePregunta(i, {pregunta: $event})"
                       placeholder="Escribe la pregunta" />
              </div>

              <div class="form-grid-2">
                <div class="form-group">
                  <label>Tipo</label>
                  <select class="form-select"
                          [ngModel]="p.tipo"
                          (ngModelChange)="updatePregunta(i, {tipo: $event})">
                    <option>Técnica</option>
                    <option>Conductual</option>
                    <option>Situacional</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Peso (%)</label>
                  <input class="form-input" type="number"
                         [ngModel]="p.peso"
                         (ngModelChange)="updatePregunta(i, {peso: +$event})" />
                </div>
              </div>

              <div class="form-group">
                <label>Palabras clave esperadas (separadas por coma)</label>
                <input class="form-input"
                       [ngModel]="p.palabrasClave"
                       (ngModelChange)="updatePregunta(i, {palabrasClave: $event})"
                       placeholder="hooks, estado, renders..." />
              </div>
            </div>
          </div>
        </section>

      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeModal()">Cancelar</button>
        <button class="btn-primary" (click)="guardarVacante()" [disabled]="loading()">
          Guardar
          <span *ngIf="loading()" class="loading-spinner" style="margin-left:.5rem;"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- ======= CHAT DRAWER (postulante) ======= -->
  <div class="chat-overlay" *ngIf="chatOpen()" (click)="closeChat()"></div>
  <aside class="chat-drawer" [class.open]="chatOpen()">
    <div class="chat-header">
      <div class="chat-title">
        <strong>Entrevista IA</strong>
        <div *ngIf="chatVacante()">— {{ chatVacante()?.puesto }}</div>
      </div>
      <button class="btn-close" (click)="closeChat()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </div>

    <div class="chat-body" #chatScroll>
      <div *ngFor="let m of chatMessages()"
           [ngClass]="m.from === 'user' ? 'bubble bubble-user' : 'bubble bubble-bot'">
        <div>{{ m.text }}</div>
        <div class="bubble-time">{{ m.time }}</div>
      </div>
    </div>

    <form class="chat-input" (submit)="sendMessage($event)">
      <input class="form-input" placeholder="Escribe tu respuesta..."
             [(ngModel)]="chatDraft" name="chatDraft" />
      <button class="btn-primary" type="submit">Enviar</button>
    </form>
  </aside>

</div>
