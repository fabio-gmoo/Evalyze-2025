<!-- Contenedor principal -->
<div class="vacantes-container">

  <!-- === Header === -->
  <div class="header">
    <div class="header-content">
      <div class="header-icon">
        <!-- ícono simple -->
        <svg class="icon-24" viewBox="0 0 24 24" fill="none">
          <path d="M4 7h16M4 12h10M4 17h7" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div>
        <h1>Vacantes</h1>
        <p *ngIf="viewMode() === 'company'">Panel para gestionar posiciones y entrevistas con IA</p>
        <p *ngIf="viewMode() === 'candidate'">Explora vacantes y realiza entrevistas automatizadas</p>
      </div>
    </div>

    <!-- Barra de búsqueda (solo postulante) -->
    <div *ngIf="viewMode() === 'candidate'" class="search-bar">
      <div class="search-input">
        <svg class="icon-20" viewBox="0 0 24 24" fill="none">
          <circle cx="11" cy="11" r="7" stroke="#64748b" stroke-width="2"/>
          <path d="M20 20l-3.5-3.5" stroke="#64748b" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <input type="text" placeholder="Buscar por puesto, empresa o ubicación…">
      </div>
      <select class="form-select search-select">
        <option value="">Tipo de cuenta</option>
        <option>Empresa</option>
        <option>Postulante</option>
      </select>
      <button class="btn-primary">
        Buscar
      </button>
    </div>
  </div>

  <!-- === Stats (solo empresa) === -->
  <div *ngIf="viewMode() === 'company'" class="stats-grid">
    <div class="stat-card stat-{{s.color}}" *ngFor="let s of stats()">
      <h3>{{ s.title }}</h3>
      <div class="stat-value">{{ s.value }}</div>
      <div class="stat-change">{{ s.change }}</div>
    </div>
  </div>

  <!-- === Tabs (solo empresa) === -->
  <div *ngIf="viewMode() === 'company'" class="tabs">
    <button
      *ngFor="let t of tabs"
      class="tab-button"
      [class.active]="activeTab() === t.id"
      (click)="setActiveTab(t.id)"
    >
      {{ t.label }}
    </button>
  </div>

  <!-- === Sección de Vacantes (empresa y postulante) === -->
  <div class="section-header">
    <div>
      <h2 *ngIf="viewMode() === 'company'">Gestión de Vacantes</h2>
      <h2 *ngIf="viewMode() === 'candidate'">Todas las Vacantes</h2>
      <p *ngIf="viewMode() === 'company'">Crea y administra posiciones con configuración de IA personalizada</p>
      <p *ngIf="viewMode() === 'candidate'">Aplica y conversa con nuestro asistente para avanzar rápido</p>
    </div>

    <div *ngIf="viewMode() === 'company'">
      <button class="btn-primary" (click)="openModal(null)">
        <svg class="icon-18" viewBox="0 0 24 24" fill="none">
          <path d="M12 5v14M5 12h14" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Nueva Vacante
      </button>
    </div>
  </div>

  <!-- Loader -->
  <div *ngIf="loading()" class="empty-state">
    <div class="loading-spinner"></div>
    <h3 class="mt-3">Cargando…</h3>
  </div>

  <!-- Lista / Vacío -->
  <ng-container *ngIf="!loading()">
    <div *ngIf="!vacantes().length" class="empty-state">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M4 7h16M4 12h10M4 17h7" stroke="#94a3b8" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <h3>No hay vacantes</h3>
      <p *ngIf="viewMode() === 'company'">Crea tu primera vacante para comenzar</p>
      <button *ngIf="viewMode() === 'company'" class="btn-primary" (click)="openModal(null)">
        Crear vacante
      </button>
    </div>

    <div class="vacantes-list" *ngIf="vacantes().length">
      <div class="vacante-card" *ngFor="let v of vacantes()">
        <div class="vacante-header">
          <div class="vacante-title-section">
            <h3>{{ v.puesto }}</h3>
            <span class="badge-active" *ngIf="v.activa">Activa</span>
          </div>

          <!-- Acciones según modo -->
          <div class="vacante-actions" *ngIf="viewMode() === 'company'">
            <button class="btn-icon" (click)="openModal(v)">
              <svg class="icon-18" viewBox="0 0 24 24" fill="none">
                <path d="M12 20h9" stroke="#94a3b8" stroke-width="2" stroke-linecap="round"/>
                <path d="M16.5 3.5a2.121 2.121 0 013 3L8 18l-4 1 1-4 11.5-11.5z" stroke="#94a3b8" stroke-width="2" stroke-linejoin="round"/>
              </svg>
              Editar
            </button>
            <button class="btn-icon-only btn-delete" (click)="eliminarVacante(v.id!)" title="Eliminar">
              <svg class="icon-18" viewBox="0 0 24 24" fill="none">
                <path d="M6 7h12M9 7v10m6-10v10M10 4h4l1 3H9l1-3z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>

          <div class="vacante-actions" *ngIf="viewMode() === 'candidate'">
            <button class="chip chip-blue" (click)="openChat(v)">Aplicar Ahora</button>
          </div>
        </div>

        <div class="vacante-info-grid">
          <div class="info-item">
            <svg class="icon-18" viewBox="0 0 24 24" fill="none">
              <path d="M12 2l7 7-7 7-7-7 7-7z" stroke="currentColor" stroke-width="2"/>
            </svg>
            <span>{{ v.ubicacion }}</span>
          </div>
          <div class="info-item" *ngIf="v.salario">
            <svg class="icon-18" viewBox="0 0 24 24" fill="none">
              <path d="M12 6v12M6 10h8a3 3 0 110 6H6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span>$ {{ v.salario }} EUR</span>
          </div>
          <div class="info-item" *ngIf="v.departamento">
            <svg class="icon-18" viewBox="0 0 24 24" fill="none">
              <path d="M4 6h16M4 12h16M4 18h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span>{{ v.departamento }}</span>
          </div>
          <div class="info-item" *ngIf="viewMode() === 'company'">
            <svg class="icon-18" viewBox="0 0 24 24" fill="none">
              <path d="M16 11a4 4 0 10-8 0v5H5a1 1 0 00-1 1v3h16v-3a1 1 0 00-1-1h-3v-5z" stroke="currentColor" stroke-width="2"/>
            </svg>
            <span>{{ v.candidatos }} candidatos</span>
          </div>
          <div class="info-item">
            <svg class="icon-18" viewBox="0 0 24 24" fill="none">
              <path d="M12 8v5l3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span>{{ v.duracionIA }}</span>
          </div>
        </div>

        <div class="vacante-description">
          {{ v.descripcion }}
        </div>

        <div class="tag-list" *ngIf="v.requisitos?.length">
          <span class="chip" *ngFor="let r of v.requisitos">{{ r }}</span>
        </div>

        <div class="vacante-footer">
          <div>Publicada: {{ v.publicada }}</div>
          <div>Cierra: {{ v.cierra }}</div>
          <div *ngIf="viewMode() === 'company'">{{ v.preguntasIA }} preguntas IA configuradas</div>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- =============== Modal Crear/Editar =============== -->
  <div class="modal-overlay" *ngIf="showModal()">
    <div class="modal-content">
      <div class="modal-header">
        <h2>{{ editingVacante() ? 'Editar Vacante' : 'Nueva Vacante' }}</h2>
        <button class="btn-close" (click)="closeModal()">
          <svg class="icon-18" viewBox="0 0 24 24" fill="none">
            <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <!-- Información básica -->
        <div class="form-section">
          <h3>Información del Puesto</h3>
          <div class="form-grid-2">
            <div class="form-group">
              <label>Puesto</label>
              <input class="form-input" [ngModel]="formData().puesto" (ngModelChange)="updateFormField('puesto', $event)" placeholder="Ej. Desarrollador Frontend Senior">
            </div>
            <div class="form-group">
              <label>Departamento / Área</label>
              <input class="form-input" [ngModel]="formData().departamento" (ngModelChange)="updateFormField('departamento', $event)" placeholder="Ej. Tecnología">
            </div>
            <div class="form-group">
              <label>Ubicación</label>
              <input class="form-input" [ngModel]="formData().ubicacion" (ngModelChange)="updateFormField('ubicacion', $event)" placeholder="Ciudad, País">
            </div>
            <div class="form-group">
              <label>Tipo de Contrato</label>
              <select class="form-select" [ngModel]="formData().tipo_contrato" (ngModelChange)="updateFormField('tipo_contrato', $event)">
                <option>Tiempo Completo</option>
                <option>Medio Tiempo</option>
                <option>Contrato</option>
                <option>Prácticas</option>
              </select>
            </div>
            <div class="form-group">
              <label>Salario Mínimo</label>
              <input type="number" class="form-input" [ngModel]="formData().salarioMin" (ngModelChange)="updateFormField('salarioMin', $event)" placeholder="45000">
            </div>
            <div class="form-group">
              <label>Salario Máximo</label>
              <input type="number" class="form-input" [ngModel]="formData().salarioMax" (ngModelChange)="updateFormField('salarioMax', $event)" placeholder="65000">
            </div>
          </div>

          <div class="form-group">
            <div class="form-group-header">
              <label>Descripción del Puesto</label>
              <button class="btn-generate-ia" (click)="generarConIA()">
                <svg class="icon-18" viewBox="0 0 24 24" fill="none">
                  <path d="M12 3l2.5 5L20 9l-4 4 .9 6-4.9-2.7L7 19l1-6-4-4 5.5-1L12 3z" stroke="white" stroke-width="1.6" stroke-linejoin="round"/>
                </svg>
                Generar con IA
              </button>
            </div>
            <textarea class="form-textarea" rows="6" [ngModel]="formData().descripcion" (ngModelChange)="updateFormField('descripcion', $event)" placeholder="Describe el rol, responsabilidades y objetivos…"></textarea>
            <div class="form-help">Usa el botón “Generar con IA” para auto-completar con un contenido base.</div>
          </div>
        </div>

        <!-- Requisitos -->
        <div class="form-section">
          <h3>Requisitos</h3>
          <div class="array-input-group" *ngFor="let r of formData().requisitos; let i = index">
            <input class="form-input" [ngModel]="r" (ngModelChange)="updateArrayItem('requisitos', i, $event)" placeholder="Ej. React + TypeScript avanzado">
            <button class="btn-remove" (click)="removeArrayItem('requisitos', i)">
              <svg class="icon-16" viewBox="0 0 24 24" fill="none">
                <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
          <button class="btn-add-item" (click)="addArrayItem('requisitos')">Añadir requisito</button>
        </div>

        <!-- Responsabilidades -->
        <div class="form-section">
          <h3>Responsabilidades</h3>
          <div class="array-input-group" *ngFor="let r of formData().responsabilidades; let i = index">
            <input class="form-input" [ngModel]="r" (ngModelChange)="updateArrayItem('responsabilidades', i, $event)" placeholder="Ej. Desarrollar interfaces de usuario">
            <button class="btn-remove" (click)="removeArrayItem('responsabilidades', i)">
              <svg class="icon-16" viewBox="0 0 24 24" fill="none">
                <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
          <button class="btn-add-item" (click)="addArrayItem('responsabilidades')">Añadir responsabilidad</button>
        </div>

        <!-- Configuración de Entrevista IA -->
        <div class="form-section">
          <h3>Configuración de Entrevista IA</h3>

          <div class="form-grid-2">
            <div class="form-group">
              <label>Duración (min)</label>
              <input type="number" class="form-input" [ngModel]="formData().duracion" (ngModelChange)="updateFormField('duracion', $event)">
            </div>
            <div class="form-group">
              <label>Puntuación mínima (%)</label>
              <input type="number" class="form-input" [ngModel]="formData().puntuacionMinima" (ngModelChange)="updateFormField('puntuacionMinima', $event)">
            </div>
          </div>

          <div class="pregunta-card" *ngFor="let p of preguntas(); trackBy: p.id">
            <div class="pregunta-header">
              <h4>Pregunta {{ p.id }}</h4>
              <span class="chip chip-purple">technical</span>
            </div>

            <div class="form-group">
              <label>Texto de la pregunta</label>
              <input class="form-input" [(ngModel)]="p.pregunta" placeholder="¿Puedes explicar la diferencia entre useState y useEffect en React?">
            </div>

            <div class="form-grid-2">
              <div class="form-group">
                <label>Tipo</label>
                <select class="form-select" [(ngModel)]="p.tipo">
                  <option>Técnica</option>
                  <option>Experiencia</option>
                  <option>Comportamental</option>
                </select>
              </div>
              <div class="form-group">
                <label>Peso (%)</label>
                <input type="number" class="form-input" [(ngModel)]="p.peso">
              </div>
            </div>

            <div class="form-group">
              <label>Palabras clave (separadas por coma)</label>
              <input class="form-input" [(ngModel)]="p.palabrasClave" placeholder="hooks, estado, efecto, renders, dependencias">
            </div>
          </div>

          <button class="btn-add-question" (click)="preguntas.set([...preguntas(), { id: preguntas().length + 1, pregunta: '', tipo: 'Técnica', peso: 20, palabrasClave: '' }])">
            Añadir pregunta
          </button>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeModal()">Cancelar</button>
        <button class="btn-primary" [disabled]="loading()" (click)="guardarVacante()">
          <span *ngIf="loading()" class="loading-spinner"></span>
          <span *ngIf="!loading()">Guardar</span>
        </button>
      </div>
    </div>
  </div>

  <!-- =============== Chat lateral (postulante) =============== -->
  <div class="chat-overlay" *ngIf="chatOpen()" (click)="closeChat()"></div>
  <div class="chat-drawer" [class.open]="chatOpen()">
    <div class="chat-header">
      <div class="chat-title">Entrevista IA - {{ chatVacante()?.puesto }}</div>
      <button class="btn-close" (click)="closeChat()">
        <svg class="icon-18" viewBox="0 0 24 24" fill="none">
          <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    <div #chatScroll class="chat-body">
      <div *ngFor="let m of chatMessages()"
           class="bubble"
           [class.bubble-user]="m.from === 'user'"
           [class.bubble-bot]="m.from === 'bot'">
        <div>{{ m.text }}</div>
        <div class="bubble-time">{{ m.time }}</div>
      </div>
    </div>

    <form class="chat-input" (submit)="sendMessage($event)">
      <input class="form-input" [(ngModel)]="chatDraft" name="chat" placeholder="Escribe tu respuesta…">
      <button class="btn-primary" type="submit">
        <svg class="icon-18" viewBox="0 0 24 24" fill="none">
          <path d="M4 12l16-8-6 16-2-6-8-2z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
        </svg>
      </button>
    </form>
  </div>
</div>
